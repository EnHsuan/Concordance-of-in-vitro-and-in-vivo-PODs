---
title: "dose-response data for 26 chemicals"
author: "En-Hsuan Lu"
date: "2023-05-17"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(ggpubr)
knitr::opts_chunk$set(echo = TRUE)
```

## read chemicals

```{r read}
chem <- read.csv("26 cardio chemicals orig POD x Css.csv")
dr_conc <- read.csv("dr_cont_26chem.csv")
dr_dich <- read.csv("dr_dich_26chem.csv")

dr_dich$mean <- dr_dich$incidence/dr_dich$N
dr_dich$SD <- (dr_dich$mean*(1-dr_dich$mean)/dr_dich$N)^(1/2)
```

## 1,2,4,5-tetrachlorobenzene

```{r ggplot}
#1,2,4,5-tetrachlorobenzene
tcb.orig <- ggplot(subset(dr_dich, chemical %in% "1,2,4,5-tetrachlorobenzene"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 0.041, linetype="dashed", color="red")+
  annotate("label", x=0.041, y=Inf, vjust = 2, label="LOAEL", color="red")+
  ggtitle("1,2,4,5-Tetrachlorobenzene", subtitle="Thyroid pathology in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(tcb.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","1245-tcb-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "1,2,4,5-tetrachlorobenzene")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (20.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (7.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (21.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (7.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (23.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (8.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (7.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (3.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","1245-tcb-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.041, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

tcb.dr <- ggarrange(tcb.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(tcb.dr)
ggsave("1,2,4,5-tetrachlorobenzene.pdf",plot=tcb.dr, width=24, height=6, path="BBMD dose-response plot")
```

## 1,3-dinitrobenzene
Increased splenic weight male
the most sensitive POD

```{r ggplot}
dnb.m.orig <- ggplot(subset(dr_conc, chemical %in% "1,3-dinitrobenzene" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.05)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 0.4, linetype="dashed", color="red")+
  annotate("label", x=0.4, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("1,3-Dinitrobenzene", subtitle="Increased splenic weight in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(dnb.m.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","13-dnb-males-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "1,3-dinitrobenzene" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (35.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (14.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (17.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (32.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","13-dnb-males-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.4, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

dnb.m.dr <- ggarrange(dnb.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(dnb.m.dr)
ggsave("1,3-dinitrobenzene male.pdf",plot=dnb.m.dr, width=24, height=6, path="BBMD dose-response plot")
```

## 1,3-dinitrobenzene
Increased splenic weight female

```{r ggplot}
dnb.f.orig <- ggplot(subset(dr_conc, chemical %in% "1,3-dinitrobenzene" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.05)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 0.4, linetype="dashed", color="red")+
  annotate("label", x=0.4, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("1,3-Dinitrobenzene", subtitle="Increased splenic weight in females")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(dnb.f.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","13-dnb-females-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "1,3-dinitrobenzene" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (49.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (50.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","13-dnb-females-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.4, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

dnb.f.dr <- ggarrange(dnb.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(dnb.f.dr)
ggsave("1,3-dinitrobenzene female.pdf",plot=dnb.f.dr, width=24, height=6, path="BBMD dose-response plot")
```

## 1,4-dichlorobenzene

```{r ggplot}
dcb.orig <- ggplot(subset(dr_conc, chemical %in% "1,4-dichlorobenzene"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (IU/L)")+
  geom_vline(xintercept = 7, linetype="dashed", color="red")+
  annotate("label", x=7, y=Inf, vjust=2, label="BMDL", color="red")+
  ggtitle("1,4-Dichlorobenzene", subtitle="Increased serum AP")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(dcb.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","dichlorobenzene-14-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "1,4-dichlorobenzene")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (35.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (13.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (0.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (9.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (14.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (23.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (0.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (2.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","dichlorobenzene-14-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 7, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

dcb.dr <- ggarrange(dcb.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(dcb.dr)
ggsave("1,4-dichlorobenzene.pdf",plot=dcb.dr, width=24, height=6, path="BBMD dose-response plot")
```

## 2-mercaptobenzothiazole

```{r ggplot}
mtb.orig <- ggplot(subset(dr_conc, chemical %in% "2-mercaptobenzothiazole"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 14.8, linetype="dashed", color="red")+
  annotate("label", x=14.8, y=Inf, vjust=2, label="BMDL", color="red")+
  ggtitle("2-Mercaptobenzothiazole", subtitle="Increased relative liver weight")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(mtb.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","2-mercaptobenzothiazole-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "2-mercaptobenzothiazole")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (23.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (2.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (16.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (56.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","2-mercaptobenzothiazole-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 14.8, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

mtb.dr <- ggarrange(mtb.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(mtb.dr)
ggsave("2-mercaptobenzothiazole.pdf",plot=mtb.dr, width=24, height=6, path="BBMD dose-response plot")
```

## 2,4,5-trichlorophenoxyacetic acid
female
the most sensitive POD

```{r ggplot}
tcp.f.orig <- ggplot(subset(dr_conc, chemical %in% "2,4,5-trichlorophenoxyacetic acid" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μg/48 hr)")+
  geom_vline(xintercept = 3, linetype="dashed", color="red")+
  annotate("label", x=3, y=Inf, vjust=2, label="LOAEL", color="red")+
  ggtitle("2,4,5-Trichlorophenoxyacetic acid", subtitle="Increased urinary coproporphyrins in females")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(tcp.f.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","245-tcp-acid-females-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "2,4,5-trichlorophenoxyacetic acid" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (4.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (2.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (52.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (31.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (2.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (2.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (4.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","245-tcp-acid-females-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 3, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

tcp.f.dr <- ggarrange(tcp.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(tcp.f.dr)
ggsave("2,4,5-trichlorophenoxyacetic acid female.pdf",plot=tcp.f.dr, width=24, height=6, path="BBMD dose-response plot")
```

## 2,4,5-trichlorophenoxyacetic acid
male

```{r ggplot}
tcp.m.orig <- ggplot(subset(dr_conc, chemical %in% "2,4,5-trichlorophenoxyacetic acid" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μg/48 hr)")+
  geom_vline(xintercept = 3, linetype="dashed", color="red")+
  annotate("label", x=3, y=Inf, vjust=2, label="LOAEL", color="red")+
  ggtitle("2,4,5-Trichlorophenoxyacetic acid", subtitle="Increased urinary coproporphyrins in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(tcp.m.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","245-tcp-acid-males-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "2,4,5-trichlorophenoxyacetic acid" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (32.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (17.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (16.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (33.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","245-tcp-acid-males-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 3, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

tcp.m.dr <- ggarrange(tcp.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(tcp.m.dr)
ggsave("2,4,5-trichlorophenoxyacetic acid male.pdf",plot=tcp.m.dr, width=24, height=6, path="BBMD dose-response plot")
```

## 3-nitrotoluene

```{r ggplot}
#3-nitrotoluene
threent.orig <- ggplot(subset(dr_dich, chemical %in% "3-nitrotoluene"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.1, linetype="dashed", color="red")+
  annotate("label", x=1.1, y=Inf, vjust = 2, label="BMDL", color="red")+
  ggtitle("3-Nitrotoluene", subtitle="Spleen hemosiderin deposition in female rats")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(threent.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","nitrotoluene-m-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "3-nitrotoluene")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (32.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (1.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (0.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (0.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (65.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","nitrotoluene-m-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

threent.dr <- ggarrange(threent.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(threent.dr)
ggsave("3-nitrotoluene.pdf",plot=threent.dr, width=24, height=6, path="BBMD dose-response plot")
```

## 4-nitroaniline

```{r ggplot}
##4-nitroaniline
nitroani.orig <- ggplot(subset(dr_dich, chemical %in% "4-nitroaniline"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 0.37, linetype="dashed", color="red")+
  annotate("label", x=0.37, y=Inf, vjust = 2, label="BMDL", color="red")+
  ggtitle("4-Nitroaniline", subtitle="Spleen hemosiderosis")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(nitroani.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","nitroaniline-4-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "4-nitroaniline")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (16.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (6.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (16.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (5.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (17.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (6.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (5.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (25.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","nitroaniline-4-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.37, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

nitroani.dr <- ggarrange(nitroani.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(nitroani.dr)
ggsave("4-nitroaniline.pdf",plot=nitroani.dr, width=24, height=6, path="BBMD dose-response plot")
```

## 4-nitrotoluene
male 
the most sensitive POD

```{r ggplot}
##4-nitrotoluene
fournt.m.orig <- ggplot(subset(dr_dich, chemical %in% "4-nitrotoluene" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.1, linetype="dashed", color="red")+
  annotate("label", x=1.1, y=Inf, vjust = 2, label="BMDL", color="red")+
  ggtitle("4-Nitrotoluene", subtitle="Spleen pigmentation in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(fournt.m.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","nitrotoluene-p-males-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "4-nitrotoluene" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (0.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (35.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (0.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (18.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (23.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (5.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (4.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (12.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","nitrotoluene-p-males-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

fournt.m.dr <- ggarrange(fournt.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(fournt.m.dr)
ggsave("4-nitrotoluene male.pdf",plot=fournt.m.dr, width=24, height=6, path="BBMD dose-response plot")
```

## 4-nitrotoluene
female

```{r ggplot}
##4-nitrotoluene
fournt.f.orig <- ggplot(subset(dr_dich, chemical %in% "4-nitrotoluene" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.1, linetype="dashed", color="red")+
  annotate("label", x=1.1, y=Inf, vjust = 2, label="BMDL", color="red")+
  ggtitle("4-Nitrotoluene", subtitle="Spleen pigmentation in females")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(fournt.f.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","nitrotoluene-p-females-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "4-nitrotoluene" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (42.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (7.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (6.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (41.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (1.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, qlinear_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","nitrotoluene-p-females-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

fournt.f.dr <- ggarrange(fournt.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(fournt.f.dr)
ggsave("4-nitrotoluene female.pdf",plot=fournt.f.dr, width=24, height=6, path="BBMD dose-response plot")
```

## biphenyl

```{r ggplot}
##biphenyl
biphenyl.orig <- ggplot(subset(dr_dich, chemical %in% "biphenyl"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 58, linetype="dashed", color="red")+
  annotate("label", x=58, y=Inf, vjust = 2, label="BMDL", color="red")+
  ggtitle("Biphenyl", subtitle="Renal papillary mineralization in male F344 rats")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(biphenyl.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","biphenyl-11-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "biphenyl")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (20.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (8.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (19.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (8.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (18.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (10.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (9.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (4.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","biphenyl-11-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 58, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

biphenyl.dr <- ggarrange(biphenyl.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(biphenyl.dr)
ggsave("biphenyl.pdf",plot=biphenyl.dr, width=24, height=6, path="BBMD dose-response plot")
```

## butyl benzyl phthalate

```{r ggplot}
bbp.orig <- ggplot(subset(dr_conc, chemical %in% "butyl benzyl phthalate"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (mg/g)")+
  geom_vline(xintercept = 159, linetype="dashed", color="red")+
  annotate("label", x=159, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Butyl benzyl phthalate", subtitle="Significantly increased liver-to-body weight ratio")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(bbp.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","butyl-benzyl-phthalate-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "butyl benzyl phthalate")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (18.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (5.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (1.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (29.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (25.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (11.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (8.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","butyl-benzyl-phthalate-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 159, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

bbp.dr <- ggarrange(bbp.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(bbp.dr)
ggsave("butyl benzyl phthalate.pdf",plot=bbp.dr, width=24, height=6, path="BBMD dose-response plot")
```

## cacodylic acid

```{r ggplot}
##cacodylic acid
caco.orig <- ggplot(subset(dr_dich, chemical %in% "cacodylic acid"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.8, linetype="dashed", color="red")+
  annotate("label", x=1.8, y=Inf, vjust = 2, label="BMDL", color="red")+
  ggtitle("Cacodylic acid", subtitle="Vacuolization of urothelium in urinary bladder")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(caco.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","cacodylic-acid-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "cacodylic acid")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (12.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (33.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (35.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (0.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (1.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (8.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (8.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","cacodylic-acid-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.8, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

caco.dr <- ggarrange(caco.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(caco.dr)
ggsave("cacodylic acid.pdf",plot=caco.dr, width=24, height=6, path="BBMD dose-response plot")
```

# caprolactam
male
the most sensitive POD

```{r ggplot}
# caprolactam
#male
capro.m.orig <- ggplot(subset(dr_conc, chemical %in% "caprolactam" & sex=="male"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 50, linetype="dashed", color="red")+
  annotate("label", x=50, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Caprolactam", subtitle="Reduced offspring body weight in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(capro.m.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","caprolactam-males-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "caprolactam" & sex=="male")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (15.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (14.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (5.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (8.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (9.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (15.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (6.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (25.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","caprolactam-males-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 50, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

capro.m.dr <- ggarrange(capro.m.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(capro.m.dr)
ggsave("caprolactam male.pdf",plot=capro.m.dr, width=24, height=6, path="BBMD dose-response plot")
```

# caprolactam
female

```{r ggplot}
# caprolactam
#female
capro.f.orig <- ggplot(subset(dr_conc, chemical %in% "caprolactam" & sex=="female"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 50, linetype="dashed", color="red")+
  annotate("label", x=50, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Caprolactam", subtitle="Reduced offspring body weight in females")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(capro.f.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","caprolactam-females-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "caprolactam" & sex=="female")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (1.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (28.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (0.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (18.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (18.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (29.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (0.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (3.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","caprolactam-females-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 50, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

capro.f.dr <- ggarrange(capro.f.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(capro.f.dr)
ggsave("caprolactam female.pdf",plot=capro.f.dr, width=24, height=6, path="BBMD dose-response plot")
```

#di-n-octyl phthalate

```{r ggplot}
#di-n-octyl phthalate
dnp.orig <- ggplot(subset(dr_dich, chemical %in% "di-n-octyl phthalate"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 36.8, linetype="dashed", color="red")+
  annotate("label", x=36.8, y=Inf, vjust = 2, label="NOAEL", color="red")+
  ggtitle("Di-n-octyl phthalate", subtitle="Cytoplasmic vacuolation in the liver")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(dnp.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","di-n-octyl-phthalate-vacuolation-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "di-n-octyl phthalate")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (33.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (7.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (34.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (7.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (2.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (3.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (7.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (3.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","di-n-octyl-phthalate-vacuolation-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 36.8, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

dnp.dr <- ggarrange(dnp.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(dnp.dr)
ggsave("di-n-octyl phthalate.pdf",plot=dnp.dr, width=24, height=6, path="BBMD dose-response plot")
```

## hexachlorocyclopentadiene

```{r ggplot}
##hexachlorocyclopentadiene
hccpd.orig <- ggplot(subset(dr_dich, chemical %in% "hexachlorocyclopentadiene"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 6, linetype="dashed", color="red")+
  annotate("label", x=6, y=Inf, vjust = 2, label="BMDL", color="red")+
  ggtitle("Hexachlorocyclopentadiene", subtitle="Chronic irritation")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(hccpd.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","hexachlorocyclopentadiene-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "hexachlorocyclopentadiene")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (3.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (25.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (1.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (25.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (17.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (7.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (8.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (10.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","hexachlorocyclopentadiene-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 6, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

hccpd.dr <- ggarrange(hccpd.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(hccpd.dr)
ggsave("hexachlorocyclopentadiene.pdf",plot=hccpd.dr, width=24, height=6, path="BBMD dose-response plot")
```

## methyl ethyl ketone

```{r ggplot}
mek.orig <- ggplot(subset(dr_conc, chemical %in% "methyl ethyl ketone"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 639, linetype="dashed", color="red")+
  annotate("label", x=639, y=Inf, vjust=2, label="LED50", color="red")+
  ggtitle("Methyl ethyl ketone", subtitle="Decreased pup body weight")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(mek.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","methyl-ethyl-ketone-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "methyl ethyl ketone")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.049%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (55.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (0.013%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (44.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (0.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","methyl-ethyl-ketone-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 639, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

mek.dr <- ggarrange(mek.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(mek.dr)
ggsave("methyl ethyl ketone.pdf",plot=mek.dr, width=24, height=6, path="BBMD dose-response plot")
```

## mirex
angiectasis
the most sensitive POD

```{r ggplot}
##mirex
#angiectasis
mirex.ang.orig <- ggplot(subset(dr_dich, chemical %in% "mirex" & endpoint=="angiectasis"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 0.07, linetype="dashed", color="red")+
  annotate("label", x=0.07, y=Inf, vjust = 2, label="NOAEL", color="red")+
  ggtitle("Mirex", subtitle="Angiectasis")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(mirex.ang.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","mirex-angiectasis-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "mirex" & endpoint=="angiectasis")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (1.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (0.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (98.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","mirex-angiectasis-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.07, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

mirex.ang.dr <- ggarrange(mirex.ang.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(mirex.ang.dr)
ggsave("mirex angiectasis.pdf",plot=mirex.ang.dr, width=24, height=6, path="BBMD dose-response plot")
```

## mirex
hepatocytomegaly

```{r ggplot}
##mirex
#hepatocytomegaly
mirex.hep.orig <- ggplot(subset(dr_dich, chemical %in% "mirex" & endpoint=="hepatocytomegaly"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 0.07, linetype="dashed", color="red")+
  annotate("label", x=0.07, y=Inf, vjust = 2, label="NOAEL", color="red")+
  ggtitle("Mirex", subtitle="Liver cytomegaly")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(mirex.hep.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","mirex-hepatocytomegaly-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "mirex" & endpoint=="hepatocytomegaly")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (1.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (99.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","mirex-hepatocytomegaly-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.07, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

mirex.hep.dr <- ggarrange(mirex.hep.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(mirex.hep.dr)
ggsave("mirex hepatocytomegaly.pdf",plot=mirex.hep.dr, width=24, height=6, path="BBMD dose-response plot")
```

## mirex
metamorphosis

```{r ggplot}
##mirex
#metamorphosis
mirex.meta.orig <- ggplot(subset(dr_dich, chemical %in% "mirex" & endpoint=="metamorphosis"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 0.07, linetype="dashed", color="red")+
  annotate("label", x=0.07, y=Inf, vjust = 2, label="NOAEL", color="red")+
  ggtitle("Mirex", subtitle="Fatty metamorphosis")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(mirex.meta.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","mirex-metamorphosis-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "mirex" & endpoint=="metamorphosis")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (19.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (4.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (21.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (0.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (33.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (8.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (4.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (7.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","mirex-metamorphosis-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.07, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

mirex.meta.dr <- ggarrange(mirex.meta.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(mirex.meta.dr)
ggsave("mirex metamorphosis.pdf",plot=mirex.meta.dr, width=24, height=6, path="BBMD dose-response plot")
```

## mirex
cystic follicles

```{r ggplot}
##mirex
#cystic follicles
mirex.cys.orig <- ggplot(subset(dr_dich, chemical %in% "mirex" & endpoint=="cystic follicles"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 0.07, linetype="dashed", color="red")+
  annotate("label", x=0.07, y=Inf, vjust = 2, label="NOAEL", color="red")+
  ggtitle("Mirex", subtitle="Thyroid cystic follicles")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(mirex.cys.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","mirex-cystic-follicles-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "mirex" & endpoint=="cystic follicles")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (19.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (3.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (20.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (1.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (32.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (9.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (3.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (9.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","mirex-cystic-follicles-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.07, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

mirex.cys.dr <- ggarrange(mirex.cys.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(mirex.cys.dr)
ggsave("mirex cystic follicles.pdf",plot=mirex.cys.dr, width=24, height=6, path="BBMD dose-response plot")
```

## nitrobenzene

```{r ggplot}
nitrobenzene.orig <- ggplot(subset(dr_conc, chemical %in% "nitrobenzene"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.8, linetype="dashed", color="red")+
  annotate("label", x=1.8, y=Inf, vjust=2, label="BMDL", color="red")+
  ggtitle("Nitrobenzene", subtitle="Increased methemoglobin levels")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(nitrobenzene.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","nitrobenzene-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "nitrobenzene")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (38.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (14.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (17.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (29.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","nitrobenzene-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.8, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

nitrobenzene.dr <- ggarrange(nitrobenzene.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(nitrobenzene.dr)
ggsave("nitrobenzene.pdf",plot=nitrobenzene.dr, width=24, height=6, path="BBMD dose-response plot")
```

## p,p'-DDE

```{r ggplot}
dde.orig <- ggplot(subset(dr_conc, chemical %in% "p,p'-DDE"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%BW)")+
  geom_vline(xintercept = 5, linetype="dashed", color="red")+
  annotate("label", x=5, y=Inf, vjust=2, label="LOAEL", color="red")+
  ggtitle("p,p'-DDE", subtitle="Increased relative liver weight in adult male \noffspring")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(dde.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","dde-pp-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "p,p'-DDE")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (1.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (51.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (30.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (16.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (1.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","dde-pp-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 5, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

dde.dr <- ggarrange(dde.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(dde.dr)
ggsave("p,p'-DDE.pdf",plot=dde.dr, width=24, height=6, path="BBMD dose-response plot")
```

## p-chloroaniline

```{r ggplot}
chloroani.orig <- ggplot(subset(dr_conc, chemical %in% "chloroaniline, p-"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (% of Hgb)")+
  geom_vline(xintercept = 1.4, linetype="dashed", color="red")+
  annotate("label", x=1.4, y=Inf, vjust=2, label="LOAEL", color="red")+
  ggtitle("p-Chloroaniline", subtitle="Increased serum methemoglobin levels in males")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(chloroani.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","chloroaniline-p-males-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "chloroaniline, p-")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (27.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (7.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (12.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (52.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","chloroaniline-p-males-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.4, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

chloroani.dr <- ggarrange(chloroani.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(chloroani.dr)
ggsave("p-chloroaniline.pdf",plot=chloroani.dr, width=24, height=6, path="BBMD dose-response plot")
```

## perfluorononanoic acid
body weight gain
the most sensitive POD

```{r ggplot}
pfna.bw.orig <- ggplot(subset(dr_conc, chemical %in% "perfluorononanoic acid" & endpoint=="bw"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 1, linetype="dashed", color="red")+
  annotate("label", x=1, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Perfluorononanoic acid", subtitle="Decreased body weight gain")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(pfna.bw.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","pfna-decreased-bw-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "perfluorononanoic acid" & endpoint=="bw")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (13.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (0.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (4.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (9.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (39.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (0.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (32.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","pfna-decreased-bw-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

pfna.bw.dr <- ggarrange(pfna.bw.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(pfna.bw.dr)
ggsave("perfluorononanoic acid (PFNA) body weight gain.pdf",plot=pfna.bw.dr, width=24, height=6, path="BBMD dose-response plot")
```

## perfluorononanoic acid
eye opening

```{r ggplot}
pfna.eye.orig <- ggplot(subset(dr_conc, chemical %in% "perfluorononanoic acid" & endpoint=="eye"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.1)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (day)")+
  geom_vline(xintercept = 1, linetype="dashed", color="red")+
  annotate("label", x=1, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Perfluorononanoic acid", subtitle="Delayed eye opening")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(pfna.eye.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","pfna-eye-opening-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "perfluorononanoic acid" & endpoint=="eye")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (33.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (17.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (15.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (33.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","pfna-eye-opening-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

pfna.eye.dr <- ggarrange(pfna.eye.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(pfna.eye.dr)
ggsave("perfluorononanoic acid (PFNA) delayed eye opening.pdf",plot=pfna.eye.dr, width=24, height=6, path="BBMD dose-response plot")
```

## perfluorooctanesulfonic acid

```{r ggplot}
pfos.orig <- ggplot(subset(dr_conc, chemical %in% "perfluorooctanesulfonic acid"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=0.01)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 0.1, linetype="dashed", color="red")+
  annotate("label", x=0.1, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Perfluorooctanesulfonic acid", subtitle="Decrease in F2 offspring body weight")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(pfos.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","pfos-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "perfluorooctanesulfonic acid")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (22.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (16.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (4.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (6.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (6.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (18.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (23.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","pfos-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 0.1, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

pfos.dr <- ggarrange(pfos.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(pfos.dr)
ggsave("perfluorooctanesulfonic acid (PFOS).pdf",plot=pfos.dr, width=24, height=6, path="BBMD dose-response plot")
```

## phenol

```{r ggplot}
phenol.orig <- ggplot(subset(dr_conc, chemical %in% "phenol"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 93, linetype="dashed", color="red")+
  annotate("label", x=93, y=Inf, vjust=2, label="BMDL", color="red")+
  ggtitle("Phenol", subtitle="Decreased maternal weight gain")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(phenol.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","phenol-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "phenol")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (26.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (5.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (10.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (3.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (4.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (5.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (13.2%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (31.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","phenol-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 93, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

phenol.dr <- ggarrange(phenol.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(phenol.dr)
ggsave("phenol.pdf",plot=phenol.dr, width=24, height=6, path="BBMD dose-response plot")
```

## phenothiazine

```{r ggplot}
phenothiazine.orig <- ggplot(subset(dr_conc, chemical %in% "phenothiazine"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (K)")+
  geom_vline(xintercept = 1.59, linetype="dashed", color="red")+
  annotate("label", x=1.59, y=Inf, vjust=2, label="NOAEL", color="red")+
  ggtitle("Phenothiazine", subtitle="Increased SGOT")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(phenothiazine.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","phenothiazine-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "phenothiazine")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (13.8%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (2.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (25.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (36.6%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (4.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (2.5%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (15.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","phenothiazine-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.59, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

phenothiazine.dr <- ggarrange(phenothiazine.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(phenothiazine.dr)
ggsave("phenothiazine.pdf",plot=phenothiazine.dr, width=24, height=6, path="BBMD dose-response plot")
```

## potassium perfluorobutanesulfonate

```{r ggplot}
pfbs.orig <- ggplot(subset(dr_conc, chemical %in% "potassium perfluorobutanesulfonate"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (μg/dl)")+
  geom_vline(xintercept = 22.09, linetype="dashed", color="red")+
  annotate("label", x=22.09, y=Inf, vjust=2, label="BMDL", color="red")+
  ggtitle("Potassium perfluorobutanesulfonate", subtitle="Decreased serum total thyroxine (T4) in newborn (PND 1) mice")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(pfbs.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","pfbs-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "potassium perfluorobutanesulfonate")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (34.9%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (28.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (23.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","pfbs-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 22.09, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

pfbs.dr <- ggarrange(pfbs.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(pfbs.dr)
ggsave("potassium perfluorobutanesulfonated (PFBS).pdf",plot=pfbs.dr, width=24, height=6, path="BBMD dose-response plot")
```

## tris(1,3-dichloro-2-propyl) phosphate

```{r ggplot}
##tris(1,3-dichloro-2-propyl) phosphate
tris13.orig <- ggplot(subset(dr_dich, chemical %in% "tris(1,3-dichloro-2-propyl) phosphate"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD))+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (%)")+
  geom_vline(xintercept = 1.94, linetype="dashed", color="red")+
  annotate("label", x=1.94, y=Inf, vjust = 2, label="BMDL", color="red")+
  ggtitle("Tris(1,3-dichloro-2-propyl) phosphate", subtitle="Renal tubular epithelial hyperplasia")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(tris13.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","tris13-dichloro-2-propyl-phosphate-parameters.csv"))
dose_s <- subset(dr_dich, chemical %in% "tris(1,3-dichloro-2-propyl) phosphate")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Logistic
#y=1/(1+exp(-a-b*dose))
Logis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Logis[,i] <- 1/(1+exp(-a-b*dose$dose/max(dose_s$dose)))
}
#Plot
Logis_quan <- apply(Logis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLogis_quan <- t(Logis_quan)
tLogis_quan <- cbind(dose, tLogis_quan)
Logis_plot <- ggplot(tLogis_quan, aes(x=dose))+
  geom_ribbon(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`, 
                                        ymin=tLogis_quan$`5%`, 
                                        ymax=tLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tLogis_quan, aes(x=dose, y=tLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Logistic (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogLogistic
#y=a+(1-a)/(1+exp(-c-b*log(dose)))
logLogis <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  c <- pm$c[i+15000]
  logLogis[,i] <- a+(1-a)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose))))
}
#Plot
logLogis_quan <- apply(logLogis, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogLogis_quan <- t(logLogis_quan)
tlogLogis_quan <- cbind(dose, tlogLogis_quan)
logLogis_plot <- ggplot(tlogLogis_quan, aes(x=dose))+
  geom_ribbon(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`, 
                                        ymin=tlogLogis_quan$`5%`, 
                                        ymax=tlogLogis_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogLogis_quan, aes(x=dose, y=tlogLogis_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Logistic (1.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Probit
#y=Φ(a+b*dose)
probit <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  probit[,i] <- pnorm(a+b*dose$dose/max(dose_s$dose))
}
#Plot
probit_quan <- apply(probit, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tprobit_quan <- t(probit_quan)
tprobit_quan <- cbind(dose, tprobit_quan)
probit_plot <- ggplot(tprobit_quan, aes(x=dose))+
  geom_ribbon(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`, 
                                        ymin=tprobit_quan$`5%`, 
                                        ymax=tprobit_quan$`95%`), alpha=0.2) +
  geom_line(data=tprobit_quan, aes(x=dose, y=tprobit_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Probit (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#LogProbit
#y=a+(1-a)*Φ(c+b*log(dose))
logpro <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  logpro[,i] <- a+(1-a)*pnorm(c+b*log(dose$dose/max(dose_s$dose)))
}
#Plot
logpro_quan <- apply(logpro, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tlogpro_quan <- t(logpro_quan)
tlogpro_quan <- cbind(dose, tlogpro_quan)
logpro_plot <- ggplot(tlogpro_quan, aes(x=dose))+
  geom_ribbon(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`, 
                                        ymin=tlogpro_quan$`5%`, 
                                        ymax=tlogpro_quan$`95%`), alpha=0.2) +
  geom_line(data=tlogpro_quan, aes(x=dose, y=tlogpro_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Log Probit (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#QuantalLinear
#y=a+(1-a)*(1-exp(-b*dose))
qlinear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  qlinear[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)))
}
#Plot
qlinear_quan <- apply(qlinear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tqlinear_quan <- t(qlinear_quan)
tqlinear_quan <- cbind(dose, tqlinear_quan)
qlinear_plot <- ggplot(tqlinear_quan, aes(x=dose))+
  geom_ribbon(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`, 
                                        ymin=tqlinear_quan$`5%`, 
                                        ymax=tqlinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tqlinear_quan, aes(x=dose, y=tqlinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Quantal Linear (0.1%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Multistage2
#y=a+(1-a)*(1-exp(-b*dose-c*dose^2))
multi <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  c <- pm$c[i+75000]
  multi[,i] <- a+(1-a)*(1-exp(-b*dose$dose/max(dose_s$dose)-c*(dose$dose/max(dose_s$dose))^2))
}
#Plot
multi_quan <- apply(multi, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tmulti_quan <- t(multi_quan)
tmulti_quan <- cbind(dose, tmulti_quan)
multi_plot <- ggplot(tmulti_quan, aes(x=dose))+
  geom_ribbon(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`, 
                                        ymin=tmulti_quan$`5%`, 
                                        ymax=tmulti_quan$`95%`), alpha=0.2) +
  geom_line(data=tmulti_quan, aes(x=dose, y=tmulti_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Multistage2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Weibull
#y=a+(1-a)*(1-exp(-c*dose^b))
wei <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  wei[,i] <- a+(1-a)*(1-exp(-c*(dose$dose/max(dose_s$dose))^b))
}
#Plot
wei_quan <- apply(wei, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
twei_quan <- t(wei_quan)
twei_quan <- cbind(dose, twei_quan)
wei_plot <- ggplot(twei_quan, aes(x=dose))+
  geom_ribbon(data=twei_quan, aes(x=dose, y=twei_quan$`50%`, 
                                        ymin=twei_quan$`5%`, 
                                        ymax=twei_quan$`95%`), alpha=0.2) +
  geom_line(data=twei_quan, aes(x=dose, y=twei_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Weibull (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#DichotomousHill
#y=a*g+((a-a*g)/(1+exp(-c-b*log(dose))))
dich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  c <- pm$c[i+105000]
  g <- pm$g[i+105000]
  dich[,i] <- a*g+((a-a*g)/(1+exp(-c-b*log(dose$dose/max(dose_s$dose)))))
}
#Plot
dich_quan <- apply(dich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tdich_quan <- t(dich_quan)
tdich_quan <- cbind(dose, tdich_quan)
dich_plot <- ggplot(tdich_quan, aes(x=dose))+
  geom_ribbon(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`, 
                                        ymin=tdich_quan$`5%`, 
                                        ymax=tdich_quan$`95%`), alpha=0.2) +
  geom_line(data=tdich_quan, aes(x=dose, y=tdich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Dichotomous Hill (98.4%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Logis_plot, logLogis_plot, probit_plot, logpro_plot, 
                     qlinear_plot, multi_plot, wei_plot, dich_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","tris13-dichloro-2-propyl-phosphate-bmds.csv"))[15001:30000,]
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 1.94, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

tris13.dr <- ggarrange(tris13.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(tris13.dr)
ggsave("tris(1,3-dichloro-2-propyl) phosphate.pdf",plot=tris13.dr, width=24, height=6, path="BBMD dose-response plot")
```

## tris(2-chloroethyl)phosphate

```{r ggplot}
tris2.orig <- ggplot(subset(dr_conc, chemical %in% "tris(2-chloroethyl)phosphate"), aes(x=dose, y=mean))+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-SD, ymax=mean+SD), width=3)+
  theme_bw()+
  xlab("Dose (mg/kg-day)")+ylab("Response (g)")+
  geom_vline(xintercept = 6.9, linetype="dashed", color="red")+
  annotate("label", x=6.9, y=Inf, vjust=2, label="BMDL", color="red")+
  ggtitle("Tris(2-chloroethyl)phosphate", subtitle="Increased relative kidney weight")+
  theme(plot.title = element_text(size = 20), plot.subtitle = element_text(size=18), axis.title = element_text(size=12), axis.text = element_text(size=10))
print(tris2.orig)

#modeling
pm <- read.csv(file.path("BBMD data input","tris2-chloroethylphosphate-parameters.csv"))
dose_s <- subset(dr_conc, chemical %in% "tris(2-chloroethyl)phosphate")
dose <- data.frame(dose=seq(from=0, to=max(dose_s$dose), by=max(dose_s$dose)/50))

#Exp 2
#y=a*exp(b*dose)
Exp2 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i]
  b <- pm$b[i]
  Exp2[,i] <- a*exp(b*dose$dose/max(dose_s$dose))
}
#Plot
Exp2_quan <- apply(Exp2, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp2_quan <- t(Exp2_quan)
tExp2_quan <- cbind(dose, tExp2_quan)
Exp2_plot <- ggplot(tExp2_quan, aes(x=dose))+
  geom_ribbon(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`, 
                                        ymin=tExp2_quan$`5%`, 
                                        ymax=tExp2_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp2_quan, aes(x=dose, y=tExp2_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 2 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 3
#y=a*exp(b*(dose^g))
Exp3 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+15000]
  b <- pm$b[i+15000]
  g <- pm$g[i+15000]
  Exp3[,i] <- a*exp(b*((dose$dose/max(dose_s$dose))^g))
}
#Plot
Exp3_quan <- apply(Exp3, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp3_quan <- t(Exp3_quan)
tExp3_quan <- cbind(dose, tExp3_quan)
Exp3_plot <- ggplot(tExp3_quan, aes(x=dose))+
  geom_ribbon(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`, 
                                        ymin=tExp3_quan$`5%`, 
                                        ymax=tExp3_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp3_quan, aes(x=dose, y=tExp3_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 3 (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 4
#y=a*[c-(c-1)*exp(-b*dose)]
Exp4 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+30000]
  b <- pm$b[i+30000]
  c <- pm$c[i+30000]
  Exp4[,i] <- a*(c-(c-1)*exp(-b*(dose$dose/max(dose_s$dose))))
}
#Plot
Exp4_quan <- apply(Exp4, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp4_quan <- t(Exp4_quan)
tExp4_quan <- cbind(dose, tExp4_quan)
Exp4_plot <- ggplot(tExp4_quan, aes(x=dose))+
  geom_ribbon(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`, 
                                        ymin=tExp4_quan$`5%`, 
                                        ymax=tExp4_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp4_quan, aes(x=dose, y=tExp4_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 4 (4.7%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Exp 5
#y=a*[c-(c-1)*exp(-(b*dose)^g)]
Exp5 <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+45000]
  b <- pm$b[i+45000]
  c <- pm$c[i+45000]
  g <- pm$g[i+45000]
  Exp5[,i] <- a*(c-(c-1)*exp(-(b*(dose$dose/max(dose_s$dose)))^g))
}
#Plot
Exp5_quan <- apply(Exp5, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tExp5_quan <- t(Exp5_quan)
tExp5_quan <- cbind(dose, tExp5_quan)
Exp5_plot <- ggplot(tExp5_quan, aes(x=dose))+
  geom_ribbon(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`, 
                                        ymin=tExp5_quan$`5%`, 
                                        ymax=tExp5_quan$`95%`), alpha=0.2) +
  geom_line(data=tExp5_quan, aes(x=dose, y=tExp5_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Exponential 5 (1.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Hill
#y=a+(b*dose^g)/(c^g+dose^g)
Hill <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+60000]
  b <- pm$b[i+60000]
  c <- pm$c[i+60000]
  g <- pm$g[i+60000]
  Hill[,i] <- a+(b*(dose$dose/max(dose_s$dose))^g)/(c^g+(dose$dose/max(dose_s$dose))^g)
}
#Plot
Hill_quan <- apply(Hill, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tHill_quan <- t(Hill_quan)
tHill_quan <- cbind(dose, tHill_quan)
Hill_plot <- ggplot(tHill_quan, aes(x=dose))+
  geom_ribbon(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`, 
                                        ymin=tHill_quan$`5%`, 
                                        ymax=tHill_quan$`95%`), alpha=0.2) +
  geom_line(data=tHill_quan, aes(x=dose, y=tHill_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Hill (25.3%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Power
#y=a+b*(dose^g)
Power <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+75000]
  b <- pm$b[i+75000]
  g <- pm$g[i+75000]
  Power[,i] <- a+b*((dose$dose/max(dose_s$dose))^g)
}
#Plot
Power_quan <- apply(Power, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tPower_quan <- t(Power_quan)
tPower_quan <- cbind(dose, tPower_quan)
Power_plot <- ggplot(tPower_quan, aes(x=dose))+
  geom_ribbon(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`, 
                                         ymin=tPower_quan$`5%`, 
                                         ymax=tPower_quan$`95%`), alpha=0.2) +
  geom_line(data=tPower_quan, aes(x=dose, y=tPower_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Power (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#MichaelisMenten
#y=a+(b*dose)/(c+dose)
Mich <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+90000]
  b <- pm$b[i+90000]
  c <- pm$c[i+90000]
  Mich[,i] <- a+(b*(dose$dose/max(dose_s$dose)))/(c+dose$dose/max(dose_s$dose))
}
#Plot
Mich_quan <- apply(Mich, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tMich_quan <- t(Mich_quan)
tMich_quan <- cbind(dose, tMich_quan)
Mich_plot <- ggplot(tMich_quan, aes(x=dose))+
  geom_ribbon(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`, 
                                        ymin=tMich_quan$`5%`, 
                                        ymax=tMich_quan$`95%`), alpha=0.2) +
  geom_line(data=tMich_quan, aes(x=dose, y=tMich_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Michaelis-Menten (69.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Linear
#y=a+b*dose
Linear <- as.data.frame(matrix(NA, 51, 15000))
for (i in 1:15000){
  a <- pm$a[i+105000]
  b <- pm$b[i+105000]
  Linear[,i] <- a+b*dose$dose/max(dose_s$dose)
}
#Plot
Linear_quan <- apply(Linear, 1, quantile, prob = c(0.05,0.5,0.95), na.rm = TRUE)
tLinear_quan <- t(Linear_quan)
tLinear_quan <- cbind(dose, tLinear_quan)
Linear_plot <- ggplot(tLinear_quan, aes(x=dose))+
  geom_ribbon(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`, 
                                          ymin=tLinear_quan$`5%`, 
                                          ymax=tLinear_quan$`95%`), alpha=0.2) +
  geom_line(data=tLinear_quan, aes(x=dose, y=tLinear_quan$`50%`))+
  geom_point(data=dose_s, aes(x=dose, y=mean))+
  geom_errorbar(data=dose_s, aes(x=dose, ymin=mean-SD, ymax=mean+SD))+
  ggtitle("Linear (0.0%)") +
  theme_classic() +
  theme(plot.title=element_text(hjust=0.5)) +
  theme(text = element_text(size = 12)) +
  xlab("Dose (mg/kg-day)") + ylab("Response")

#Combine plots
combine <- ggarrange(Exp2_plot, Exp3_plot, Exp4_plot, Exp5_plot, Mich_plot, Hill_plot, Power_plot, Linear_plot,
                     ncol=4, nrow=2)
combine <- annotate_figure(combine, top = text_grob("Model Results", size = 20))

#posterior model average
bmds <- read.csv(file.path("BBMD data input","tris2-chloroethylphosphate-bmds.csv"))
quantile(bmds$model_average, prob=c(0.5, 0.05, 0.95), na.rm=TRUE)

bmds.average <- ggplot(bmds, aes(x=model_average)) + geom_density() +
  ggtitle("Model Average") + 
  theme_classic() +
  theme(plot.title = element_text(size = 20, hjust = 0.5), axis.title = element_text(size=12), axis.text = element_text(size=10))+
  geom_vline(xintercept = 6.9, color="red")+
  xlab("Dose (mg/kg-day)")+ylab("density")+
  scale_x_log10()+
  annotate("pointrange", x = quantile(bmds$model_average, prob=c(0.5), na.rm=TRUE), y = 0, 
           xmin = quantile(bmds$model_average, prob=c(0.05), na.rm=TRUE), 
           xmax = quantile(bmds$model_average, prob=c(0.95), na.rm=TRUE), size =1)

tris2.dr <- ggarrange(tris2.orig, combine, bmds.average, ncol=3, nrow=1,
                  widths = c(8, 16, 8))
print(tris2.dr)
ggsave("tris(2-chloroethyl)phosphate.pdf",plot=tris2.dr, width=24, height=6, path="BBMD dose-response plot")
```

